name: Build and Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  # --- CONFIGURATION: UPDATE THESE VALUES ---
  # Just the name of your registry (e.g., 'myregistry5592'), NOT the full URL
  AZURE_CONTAINER_REGISTRY: "myregistry12399"

  # The name of your Container App in Azure
  CONTAINER_APP_NAME: "my-dotnet-app"

  # The Resource Group where your app lives
  RESOURCE_GROUP: "my-app-rg"

  # The name you want for your Docker image
  IMAGE_NAME: "my-dotnet-react-app"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore dependencies
        run: dotnet restore
        working-directory: backend

      - name: Build
        run: dotnet build --no-restore
        working-directory: backend

      - name: Run tests
        run: dotnet test --no-build --verbosity normal
        working-directory: backend

  build:
    runs-on: ubuntu-latest
    needs: test  # Only run build if tests pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Log into Azure using the Service Principal
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2. Log into ACR using the Azure CLI (Seamlessly uses the creds above)
      - name: Log in to Container Registry
        run: az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      # 3. Build and Push the Image
      # We use standard Docker commands because they work perfectly with 'az acr login'
      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Container App
        uses: azure/container-apps-deploy-action@v1
        with:
          imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: ${{ env.CONTAINER_APP_NAME }}
